{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Senhas - MedPass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes pulse-border { 0%, 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.5); } 50% { box-shadow: 0 0 0 15px rgba(37, 99, 235, 0); } }
        .pulse-border { animation: pulse-border 2s infinite; }
        @keyframes slide-in { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slide-in 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i data-feather="activity" class="w-8 h-8 text-white"></i>
                <h1 class="text-2xl font-bold text-white">MedPass</h1>
            </div>
            <div class="flex items-center space-x-4 text-white">
                <span id="relogio" class="text-lg">--:--:--</span>
                <button onclick="testarAudio()" class="text-white/80 hover:text-white" title="Testar áudio">
                    <i data-feather="volume-2" class="w-5 h-5"></i>
                </button>
                <a href="{% url 'home' %}" class="text-white/80 hover:text-white">
                    <i data-feather="home" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Senhas Chamando -->
            <div class="lg:col-span-2 space-y-6">
                {% if senha_chamando_guiche %}
                <div id="chamada-guiche" class="bg-blue-600 rounded-2xl p-8 text-center pulse-border slide-in"
                     data-senha="{{ senha_chamando_guiche.numero }}"
                     data-local="guichê {{ senha_chamando_guiche.guiche.numero }}"
                     data-timestamp="{{ senha_chamando_guiche.chamado_guiche_em|date:'U' }}">
                    <p class="text-white/80 text-sm mb-2">GUICHÊ CHAMANDO</p>
                    <p class="text-7xl md:text-8xl font-extrabold text-white mb-4">{{ senha_chamando_guiche.numero }}</p>
                    <p class="text-2xl text-white">Guichê <strong>{{ senha_chamando_guiche.guiche.numero }}</strong></p>
                </div>
                {% endif %}

                {% if senha_chamando_medico %}
                <div id="chamada-medico" class="bg-green-600 rounded-2xl p-8 text-center pulse-border slide-in"
                     data-senha="{{ senha_chamando_medico.numero }}"
                     data-local="{% if senha_chamando_medico.profissional.sala %}sala {{ senha_chamando_medico.profissional.sala }}{% else %}doutor {{ senha_chamando_medico.profissional.nome }}{% endif %}"
                     data-timestamp="{{ senha_chamando_medico.chamado_medico_em|date:'U' }}">
                    <p class="text-white/80 text-sm mb-2">CONSULTA - MÉDICO CHAMANDO</p>
                    <p class="text-7xl md:text-8xl font-extrabold text-white mb-4">{{ senha_chamando_medico.numero }}</p>
                    <p class="text-2xl text-white">
                        {% if senha_chamando_medico.profissional.sala %}Sala <strong>{{ senha_chamando_medico.profissional.sala }}</strong>
                        {% else %}Dr(a). <strong>{{ senha_chamando_medico.profissional.nome }}</strong>{% endif %}
                    </p>
                </div>
                {% endif %}

                {% if not senha_chamando_guiche and not senha_chamando_medico %}
                <div class="bg-gray-800 rounded-2xl p-12 text-center">
                    <i data-feather="clock" class="w-16 h-16 text-gray-600 mx-auto mb-4"></i>
                    <p class="text-2xl text-gray-500">Aguardando próxima chamada...</p>
                </div>
                {% endif %}

                <!-- Últimas Chamadas -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h3 class="text-white font-semibold mb-4 flex items-center">
                        <i data-feather="list" class="w-5 h-5 mr-2"></i>
                        Últimas Chamadas
                    </h3>
                    <div class="space-y-2">
                        {% for senha in ultimas_chamadas %}
                        <div class="flex items-center justify-between bg-gray-700 rounded-lg px-4 py-3 hover:bg-gray-600 transition-colors">
                            <div class="flex items-center space-x-4">
                                <span class="text-2xl font-bold text-white">{{ senha.numero }}</span>
                                <div>
                                    <p class="text-white font-medium">{{ senha.especialidade.nome }}</p>
                                    <p class="text-xs text-gray-400">
                                        {% if senha.guiche %}
                                        <span class="text-blue-400">Guichê {{ senha.guiche.numero }}</span>
                                        {% elif senha.profissional %}
                                        <span class="text-green-400">
                                            {% if senha.profissional.sala %}Sala {{ senha.profissional.sala }}{% else %}{{ senha.profissional.nome }}{% endif %}
                                        </span>
                                        {% endif %}
                                        {% if senha.chamado_guiche_em %}
                                        · {{ senha.chamado_guiche_em|date:"H:i" }}
                                        {% elif senha.chamado_medico_em %}
                                        · {{ senha.chamado_medico_em|date:"H:i" }}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full
                                {% if senha.status == 'em_triagem' %}bg-blue-500/20 text-blue-400
                                {% elif senha.status == 'em_consulta' %}bg-green-500/20 text-green-400
                                {% elif senha.status == 'concluido' %}bg-gray-500/20 text-gray-400
                                {% else %}bg-yellow-500/20 text-yellow-400{% endif %}">
                                {{ senha.get_status_display }}
                            </span>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-center py-8">Nenhuma chamada recente</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Estatísticas -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-blue-400">{{ total_aguardando_guiche }}</p>
                        <p class="text-xs text-gray-400">Aguardando Guichê</p>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-blue-400">{{ total_aguardando_medico }}</p>
                        <p class="text-xs text-gray-400">Aguardando Médico</p>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-blue-400">{{ total_hoje }}</p>
                        <p class="text-xs text-gray-400">Senhas Hoje</p>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-green-400">{{ total_atendidas }}</p>
                        <p class="text-xs text-gray-400">Atendidas</p>
                    </div>
                </div>

                <!-- Fila Guichê -->
                <div class="bg-gray-800 rounded-xl overflow-hidden">
                    <div class="bg-blue-600 px-4 py-2">
                        <h3 class="text-white text-sm font-semibold flex items-center">
                            <i data-feather="clock" class="w-4 h-4 mr-2"></i>
                            Fila do Guichê
                        </h3>
                    </div>
                    <div class="p-4 max-h-64 overflow-y-auto space-y-2">
                        {% for senha in senhas_aguardando_guiche %}
                        <div class="flex justify-between items-center bg-gray-700 rounded px-3 py-2">
                            <div>
                                <span class="font-bold text-white text-lg">{{ senha.numero }}</span>
                                <p class="text-xs text-gray-400">{{ senha.especialidade.nome }}</p>
                            </div>
                            <span class="px-2 py-0.5 text-xs font-semibold rounded-full
                                {% if senha.tipo == 'U' %}bg-red-500/20 text-red-400
                                {% elif senha.tipo == 'P' %}bg-purple-500/20 text-purple-400
                                {% else %}bg-gray-500/20 text-gray-400{% endif %}">
                                {{ senha.get_tipo_display }}
                            </span>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-center text-sm py-4">Fila vazia</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        feather.replace();
        
        // Armazena as últimas senhas chamadas para detectar novas (usando timestamp)
        let ultimaChamadaGuiche = localStorage.getItem('ultimaChamadaGuiche') || '';
        let ultimaChamadaMedico = localStorage.getItem('ultimaChamadaMedico') || '';
        
        // Função para falar o texto usando Web Speech API
        function falar(texto) {
            return new Promise((resolve) => {
                if (!('speechSynthesis' in window)) {
                    console.log('Speech não suportado');
                    resolve();
                    return;
                }
                
                // Cancela qualquer fala em andamento
                speechSynthesis.cancel();
                
                // Aguarda um pouco para garantir que o cancel foi processado
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(texto);
                    utterance.lang = 'pt-BR';
                    utterance.rate = 0.8;
                    utterance.pitch = 1.1;
                    utterance.volume = 1;
                    
                    // Tenta usar uma voz brasileira
                    const voices = speechSynthesis.getVoices();
                    const ptVoice = voices.find(v => v.lang === 'pt-BR') 
                                || voices.find(v => v.lang.startsWith('pt'));
                    if (ptVoice) {
                        utterance.voice = ptVoice;
                    }
                    
                    utterance.onend = () => {
                        console.log('Fala concluída');
                        resolve();
                    };
                    utterance.onerror = (e) => {
                        console.error('Erro na fala:', e);
                        resolve();
                    };
                    
                    speechSynthesis.speak(utterance);
                }, 100);
            });
        }
        
        // Função para formatar a senha para fala
        function formatarSenhaParaFala(senha) {
            // Separa letras e números
            const match = senha.match(/^([A-Z]+)(\d+)$/);
            if (!match) return senha;
            
            const letras = match[1];
            const numeros = match[2];
            
            // Fala cada letra separadamente e o número sem zeros à esquerda
            const letrasFaladas = letras.split('').join(', ');
            const numeroFalado = parseInt(numeros, 10);
            
            return `${letrasFaladas}, ${numeroFalado}`;
        }
        
        // Função para chamar a senha com áudio (chamada dupla)
        async function chamarSenhaComAudio(senha, local) {
            console.log('Chamando senha:', senha, 'Local:', local);
            const senhaFormatada = formatarSenhaParaFala(senha);
            
            // Primeira chamada
            await falar(`Atenção! Senha ${senhaFormatada}. Dirija-se ao ${local}.`);
            
            // Aguarda 2 segundos
            await new Promise(r => setTimeout(r, 2000));
            
            // Segunda chamada (mais curta)
            await falar(`Senha ${senhaFormatada}, ${local}.`);
        }
        
        // Testar áudio
        function testarAudio() {
            falar('Sistema de áudio funcionando. Teste de chamada de senha.');
        }
        
        // Verifica se há novas chamadas ao carregar a página
        async function verificarNovasChamadas() {
            const chamadaGuiche = document.getElementById('chamada-guiche');
            const chamadaMedico = document.getElementById('chamada-medico');
            
            if (chamadaGuiche) {
                const senha = chamadaGuiche.dataset.senha;
                const local = chamadaGuiche.dataset.local;
                const timestamp = chamadaGuiche.dataset.timestamp;
                
                // Usa senha + timestamp como chave única (detecta rechamadas)
                const chave = `${senha}-${timestamp}`;
                console.log('Guichê - Chave atual:', chave, 'Última:', ultimaChamadaGuiche);
                
                if (chave !== ultimaChamadaGuiche) {
                    ultimaChamadaGuiche = chave;
                    localStorage.setItem('ultimaChamadaGuiche', chave);
                    console.log('Nova chamada detectada!');
                    await chamarSenhaComAudio(senha, local);
                }
            }
            
            if (chamadaMedico) {
                const senha = chamadaMedico.dataset.senha;
                const local = chamadaMedico.dataset.local;
                const timestamp = chamadaMedico.dataset.timestamp;
                
                // Usa senha + timestamp como chave única (detecta rechamadas)
                const chave = `${senha}-${timestamp}`;
                console.log('Médico - Chave atual:', chave, 'Última:', ultimaChamadaMedico);
                
                if (chave !== ultimaChamadaMedico) {
                    ultimaChamadaMedico = chave;
                    localStorage.setItem('ultimaChamadaMedico', chave);
                    console.log('Nova chamada detectada!');
                    await chamarSenhaComAudio(senha, local);
                }
            }
        }
        
        // Atualiza relógio
        function atualizarRelogio() {
            const agora = new Date();
            document.getElementById('relogio').textContent = 
                agora.toLocaleTimeString('pt-BR');
        }
        setInterval(atualizarRelogio, 1000);
        atualizarRelogio();
        
        // Carrega as vozes (necessário em alguns navegadores)
        if ('speechSynthesis' in window) {
            // Algumas vezes as vozes demoram para carregar
            speechSynthesis.getVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => {
                    speechSynthesis.getVoices();
                    console.log('Vozes carregadas');
                };
            }
        }
        
        // Verifica novas chamadas após carregar vozes
        setTimeout(verificarNovasChamadas, 1500);
        
        // Auto-refresh a cada 5 segundos
        setInterval(() => location.reload(), 5000);
    </script>
</body>
</html>
